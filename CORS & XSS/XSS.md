# XSS ( cross-site-scripting )

### ✓ 정의

- 사이트 간 스크립팅 공격
- 가장 널리 알려진 앱 보안 취약점 중 하나
- 공격 대상 사이트에 악성 스크립트를 삽입하여 사용자에게 실행되는 보안취약점
- XSS를 통해 C&C 또는 사용자의 쿠키를 탈취하여 세션 하이재킹 공격을 할 수 있다.
  - C&C : 좀비 pc에 명령을 내리거나 악성 코드 제어하는 서버로 리다이렉트

### ✓ 대표적인 공격 방식

```
1) Stored xss
2) Reflexted xss
3) DOM Based xss
```

<br/>

# Stored xss

```
공격자가 제공한 데이터가 서버에 저장된 후 페이지의 클라이언트에게 스크립트가 노출되는 공격 기법
```

### ✓ 과 정 <br/>

1. 해커가 악의적인 스크립트 포함한 게시글 작성해 사이트에 등록 (post 요청)
2. 서버에 스트링 형태로 저장
3. 사용자가 악성 스크립트를 게시글을 조회할 경우 실제 html 문서 안에 스크립트가 주입되어 공격이 실행되는 구조

<br/>

### ✓ 공격 실행 방식 <br/>

- 일반적으로 코드에서 HTML을 설정하는 것 xss 공격에 쉽게 노출되기 쉽다.
- 다행히 html 5에선 innerHTML을 통해 주입한 `<script/>` 공격 방식은 실행되지 않는다.
- 이미지 태그의 onerror 속성을 통해 스크립트 주입을 통해 xss가 이루어진다.

  - 이미지 주소가 없을 경우에 특정식 스크립트를 실행 하도록 onerror 속성을 설정

  ```
  <img src=x onerror="alert(document.cookie)"/>
  ```

<br/>

# Reflexted xss

```
 웹어플리케이션에 지정된 파라미터를 사용할 때 발생하는 취약점을 이용한 공격 방식
```

- 공격용 스크립트가 대상 웹사이트에 존재하지 않고 다른 매체에서 전송하는 공격
- Stored xss와 다르게 디비에 영구적으로 저장되지 않고 바로 요청과 동시에 공격이 이루어진다는 차이점을 가진다.
  <br/>

### ✓ 과 정 <br/>

    ex) 악의적인 스크립트를 url에 담아 전송하는 방식과 같이
    쿼리 스트링을 URL에 담아 전송하였을 경우 서버가 필터링 거치지 않고 쿼리에 포함된 스크립트를 응답 페이지에 담아 전송하게 되면서 발생한다.

1. 쿼리스트링에 스크립트를 주입시켜 실제 주소가 아닌 임의로 지정한 주소로 url이 이동하도록 생성한다.
2. 사용자가 클릭할 경우 해당 브라우저에서는 스크립트가 주입된 채로 실행이 되게 됩니다
3. 지정한 주소로 이동하며 공격이 실행된다.

<br/>

# XSS 공격 예방

> 클라이언트 측

### 1. Inner html 사용을 자제한다.<br/>

    필요한 경우가 아니라면 innerHTML 통해 검증되지 않는 데이터는 넣지 않는다.
    ➜ textContent, innerText 사용하면 태그 문자가 있어도 스크립트가 주입/실행되지 않도록 한다.

<br/>

### 2. 쿠키에 HttpOnly 옵션 활성화하여 쿠키 공격을 예방한다.

- 악성 스크립트를 통해 해커는 사용자의 정보(쿠키, 세션등)를 탈취하거나 비정상적인 기능을 수행한다.
- HttpOnly 옵션을 활성화 한다면 스크립트를 통해 document의 쿠키 메소드에 접근할 수 없게 된다. <br/>
  ➜ 이를 통해 악의적인 클라이언트가 쿠키에 저장된 정보(세선 ID, 토큰)에 접근하는 것을 차단해 공격이 불가능해진다.

<br/>

### 3. LocalStorage에 세션 ID 같은 민감 정보 저장하지 않는다.

LocalStorage를 사용시 공격으로부터 굉장히 취업한 구조가 되어 막을 방법이 존재하지 않기 때문에 쿠키 정보를 저장하지 않는다.
<br/><br/>

### 4. 라이브러리 / 프레임워크 사용 할 경우

코드에서 직접 HTML을 설정하는 것은 사이트 간 스크립팅 공격에 노출되지만, 간단한 취약점 방어 만으로도 우리는 사용자의 입력으로 부터 공격을 방어할 수가 있다.

<b>react.js</b> <br/>

- dangerouslySetInnerHTML은 브라우저 DOM에서 innerHTML을 사용하기 위한 React의 대체 방법으로, 위험함을 명시하기 위해 dangerouslySetInnerHTML을 작성하고 \_\_html 키로 객체를 전달한다.

  ```
   <div contentEditable='true' dangerouslySetInnerHTML={{ __html: "Hello" }} />
  ```

  - 위험성은 innerHTML이나 dangerouslySetInnerHTML이나 동일하며 동작은 동일하게 HTML을 삽입한다.
    동작은 DOM 노드는 삽입된 HTML로 업데이트됩니다.

  <br/>

<b>vue.js</b> <br/>

vue.js에서 v-html 디렉티브 사용 시 사용자 입력을 innerHTML와 동일한 방식으로 처리하기 때문에<br/>
공식문서에서 사용자가 제공한 콘텐츠는 v-html에 삽입하지 말것으로 명시되어 있다.
<br/> <br/>

> 서버 측

### 1. html이 입력한 입력 가능한 사이트의 공격 예방 <br/>

    N사 블로그 에디터에서 사용자가 HTML 작성 가능한 N사 블로그의 경우
    ➜ onerror 스크립트를 주입 시 문자열이 치환되어 서버측에서 처리해준다.

<br/>

### 2. XSS 특수문자를 치환하는 방법 \_ 필터

```
태그에 사용되는 각 문자를 다른 문자로 변환하여 html에서도 문자열을 그대로 출력할 수 있도록 필터 처리 해주면 된다.
```

- Spring에서 직접 구현하지 않고 Lucy XSS Servlet Filter 오픈 소스 라이브러리를 사용하면 된다.

- 하지만 RequestBody로 전달되는 json 요청에 대해서는 여전히 방어가 안되기 때문에 다른 대응이 필요하다.
